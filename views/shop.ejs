<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Senior Connect - Shop</title>
  <link rel="stylesheet" href="/shop.css">

</head>

<body>
  <%- include('partials/navbar.ejs') %>
  <header class="shop-header">
    <h1>Hello, <span class="username"><%= user.name %></span> üëã</h1>
    <div class="points-pill">
      ‚≠ê <span id="points"><%= user.u_points || 0 %></span> Points
    </div>
  </header>

  <main class="shop-grid">
    <% items.forEach(item => { %>
      <div class="shop-card"
           data-id="<%= item.id %>"
           data-name="<%= item.name %>"
           data-cost="<%= item.cost %>"
           data-image="<%= item.image %>">

        <div class="item-info">
          <h2 class="item-name"><%= item.name %></h2>
          <p class="item-desc"><%= item.description || "Comfort & care item" %></p>
          <img class="item-image" src="<%= item.image %>"></img>
        </div>

        <div class="item-footer">
          <span class="item-cost"><%= item.cost %> pts</span>
          <button class="buy-btn">Buy</button>
        </div>
      </div>
    <% }) %>
  </main>

  <!-- Popup Modal -->
<div id="popupOverlay" class="popup-overlay hidden">
  <div class="popup">
    <h2 id="popupTitle"></h2>
    <p id="popupMessage"></p>
    <button id="popupCloseBtn">OK</button>
  </div>
</div>



  <footer class="shop-footer">
    <a href="/" class="back-btn">‚Üê Back to Game</a>
  </footer>

  <script>
  const popupOverlay = document.getElementById("popupOverlay");
  const popupTitle = document.getElementById("popupTitle");
  const popupMessage = document.getElementById("popupMessage");
  const popupCloseBtn = document.getElementById("popupCloseBtn");

  function showPopup(title, message) {
    popupTitle.textContent = title;
    popupMessage.textContent = message;
    popupOverlay.classList.remove("hidden");
  }

  popupCloseBtn.addEventListener("click", () => {
    popupOverlay.classList.add("hidden");
  });

  document.querySelectorAll(".buy-btn").forEach(btn => {
    btn.addEventListener("click", async e => {
      const card = e.target.closest(".shop-card");
      const itemId = card.dataset.id;
      const itemName = card.dataset.name;

      try {
        const res = await fetch("/shop/buy", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ itemId })
        });

        const data = await res.json();

        if (data.success) {
          document.getElementById("points").textContent = data.newPoints;
          showPopup(
            "Purchase Successful üéâ",
            `You bought a ${itemName}! Enjoy üòä`
          );
        } else {
          showPopup(
            "Purchase Failed ‚ùå",
            data.message || "Not enough points."
          );
        }
      } catch (err) {
        console.error(err);
        showPopup(
          "Error",
          "Something went wrong. Please try again."
        );
      }
    });
  });
</script>

  <script src="/script.js"></script>

</body>
</html>
