<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Senior Connect - AIC Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 25px;
    }

    #summaryCards {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      flex: 1;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      text-align: left;
    }

    .card h2 {
      margin: 5px 0;
    }

    /* Search and Filter Controls */
    #controls {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      display: flex;
      gap: 15px;
      align-items: center;
    }

    #controls input,
    #controls select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    #searchInput {
      flex: 1;
      min-width: 250px;
    }

    #filterSelect,
    #statusFilter {
      min-width: 200px;
    }

    #controls label {
      font-weight: bold;
      margin-right: 10px;
    }

    #incidentTable {
      width: 100%;
      background: white;
      border-radius: 10px;
      border-collapse: collapse;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    #incidentTable th,
    #incidentTable td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    #incidentTable th {
      background: black;
      color: white;
      position: relative;
      user-select: none;
    }

    /* Sortable column headers */
    .sortable {
      cursor: pointer;
      padding-right: 25px;
    }

    .sortable:hover {
      background: #333;
    }

    .sortable::after {
      content: '⇅';
      position: absolute;
      right: 8px;
      opacity: 0.5;
      font-size: 12px;
    }

    .sortable.sort-asc::after {
      content: '▲';
      opacity: 1;
    }

    .sortable.sort-desc::after {
      content: '▼';
      opacity: 1;
    }

    tr:last-child td {
      border-bottom: none;
    }

    /* Highlight for missed check-ins */
    .missed-alert {
      background-color: #fff3cd;
    }

    /* No results message */
    .no-result {
      text-align: center;
      padding: 30px;
      color: #666;
      font-style: italic;
    }

    /* State dropdown styling */
    .state-select {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      min-width: 120px;
      background-color: white;
    }

    .state-select:hover {
      border-color: #999;
    }

    .state-select:focus {
      outline: none;
      border-color: #000;
    }

    /* State-specific colors */
    .state-select.state-new {
      background-color: #e3f2fd;
    }

    .state-select.state-in-progress {
      background-color: #fff3e0;
    }

    .state-select.state-on-hold {
      background-color: #fce4ec;
    }

    .state-select.state-resolved {
      background-color: #e8f5e9;
    }

    .state-select.state-closed {
      background-color: #f5f5f5;
    }

    /* Success/Error Notifications */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      animation: slideIn 0.3 ease-out;
    }

    .notification.success {
      background-color: green;
      color: white;
    }

    .notification.error {
      background-color: red;
      color: white;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

  </style>
</head>

<body>
  <h1>AIC Dashboard</h1>

  <!-- Summary Cards -->
  <div id="summaryCards">
    <div class="card">
      <h2 id="totalIncidents">0</h2>
      <p>Total Incidents</p>
    </div>
    <div class="card">
      <h2 id="missedAlerts">0</h2>
      <p>Missed Check-in Alerts</p>
    </div>
    <div class="card">
      <h2 id="highPriority">0</h2>
      <p>High Priority</p>
    </div>
  </div>

  <!-- Search and Filter Controls -->
  <div id="controls">
    <label for="searchInput">Search:</label>
    <input 
      type="text" 
      id="searchInput" 
      placeholder="Search by description, number, or elderly name..."
    />

    <label for="filterSelect">Filter:</label>
    <select id="filterSelect">
      <option value="all">All Active Incidents</option>
      <option value="missed" selected>Missed Check-in Alerts Only</option>
    </select>

    <label for="statusFilter">Status:</label>
    <select id="statusFilter">
      <option value="active" selected>Active Only</option>
      <option value="all">Include Closed/Resolved</option>
    </select>
  </div>

  <!-- Table -->
  <table id="incidentTable">
    <thead>
      <tr>
        <th class="sortable" data-column="number" onclick="sortTable('number')">Number</th>
        <th class="sortable" data-column="opened_at" onclick="sortTable('opened_at')">Opened</th>
        <th class="sortable" data-column="alert_type" onclick="sortTable('alert_type')">Alert Type</th>
        <th class="sortable" data-column="elderly_name" onclick="sortTable('elderly_name')">Elderly Name</th>
        <th>Priority</th>
        <th>State</th>
      </tr>
    </thead>
    <tbody id="incidentBody">
      <!-- Filled by JS -->
    </tbody>
  </table>

  <script>
    let incidentData = []
    let allIncidentData = [] // Store all data for filtering
    let currentSort = {
      column: null,
      direction: 'none' // 'none', 'asc', 'desc'
    };

    // State mapping
    const stateMap = {
      "1": "New",
      "2": "In Progress",
      "3": "On Hold",
      "6": "Resolved",
      "7": "Closed",
      "8": "Canceled"
    };

    const stateClassMap = {
      "1": "state-new",
      "2": "state-in-progress",
      "3": "state-on-hold",
      "6": "state-resolved",
      "7": "state-closed",
      "8": "state-closed"
    };

    // Priority mapping
    const priorityMap = {
      "1": "1 - Critical",
      "2": "2 - High",
      "3": "3 - Moderate",
      "4": "4 - Low",
      "5": "5 - Planning"
    };

    // --- Parse short description into alert type and elderly name ---
    function parseShortDescription(shortDesc) {
      // Example: "Missed check-in alert for: Noor Aini Binte Ismail"

      if (!shortDesc || shortDesc === "NA") {
        return { alertType: "N/A", elderlyName: "N/A" };
      }

      // Check if it contains "for:"
      if (shortDesc.includes(" for:")) {
        const parts = shortDesc.split(" for:");
        const alertType = parts[0].trim();

        // Extract elderly name, removing any session info in parentheses
        let elderlyName = parts[1] ? parts[1].trim() : "N/A";

        // Remove session info like "(morning)" or "night" if present
        elderlyName = elderlyName.replace(/\s*\(.*?\)\s*$/, '').trim();

        return { alertType, elderlyName };
      }

      // If no "for: " separator, return the whole description as alert type
      return {alertType: shortDesc, elderlyName: "N/A" };
    }

    // --- Sort table --- 
    window.sortTable = function(column, preserveDirection = false) {
      // Toggle sort direction (only if not preserving)
      if(!preserveDirection) {
        if (currentSort.column === column) {
          if (currentSort.direction === 'asc') {
            currentSort.direction = 'desc';
          } else if (currentSort.direction === 'desc') {
            currentSort.direction = 'none';
          } else {
            currentSort.direction = 'asc';
          }
        } else {
          currentSort.column = column;
          currentSort.direction = 'asc';
        }
      }
      // If preserving, currentSort already has the right values

      // Update header classes 
      document.querySelectorAll('.sortable').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
      });

      if (currentSort.direction !== 'none') {
        const header = document.querySelector(`[data-column="${currentSort.column}"]`);
        if (header) {
          header.classList.add(`sort-${currentSort.direction}`);
        }
      }

      // Sort the data
      if (currentSort.direction === 'none') {
        // Reset to original order
        incidentData = [...allIncidentData];
        renderDashboard();
        updateSummaryCards();
        return;
      }

        incidentData.sort((a, b) => {
          let valA, valB;

          if (currentSort.column === 'number') {
            // Extract numeric part from incident number (e.g. "INC0010123" -> 10123)
            valA = parseInt(a.number.replace(/[^\d]/g, '')) || 0;
            valB = parseInt(b.number.replace(/[^\d]/g, '')) || 0;

            if (currentSort.direction === 'asc') {
              return valA - valB;
            } else {
              return valB - valA;
            }
          } else if (currentSort.column === 'opened_at') {
            // Parse dates for comparison
            valA = new Date(a.opened_at).getTime() || 0;
            valB = new Date(b.opened_at).getTime() || 0;

            if (currentSort.direction === 'asc') {
              return valA - valB;
            } else {
              return valB - valA;
            }
          } else if (currentSort.column === 'alert_type') {
            // String comparison for alert type
            const parsedA = parseShortDescription(a.short_description);
            const parsedB = parseShortDescription(b.short_description);
            valA = parsedA.alertType.toLowerCase();
            valB = parsedB.alertType.toLowerCase();
            
            if (currentSort.direction === 'asc') {
              return valA.localeCompare(valB);
            } else {
              return valB.localeCompare(valA);
            }
          } else if (currentSort.column === 'elderly_name') {
            // String comparison for elderly name
            const parsedA = parseShortDescription(a.short_description);
            const parsedB = parseShortDescription(b.short_description);
            valA = parsedA.elderlyName.toLowerCase();
            valB = parsedB.elderlyName.toLowerCase();

            if (currentSort.direction === 'asc') {
              return valA.localeCompare(valB);
            } else {
              return valB.localeCompare(valA);
            }
          }

          return 0;
        });
      
        renderDashboard();
        updateSummaryCards();
      }

    // --- Show notification ---
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 3000)
    }

    // --- Update incident state with removal handling--- 
    async function updateIncidentStateWithRemoval(incidentNumber, sysId, newState) {
      try {
        const response = await fetch('/api/incidents/update-state', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            sys_id: sysId,
            state: newState
          })
        });

        const result = await response.json();

        if (result.success) {
        showNotification(result.message, 'success');
        
        // If incident will be removed, remove it from the display immediately
        if (result.data.will_be_removed) {
          // Remove from both data arrays
          allIncidentData = allIncidentData.filter(inc => inc.sys_id !== sysId);
          incidentData = incidentData.filter(inc => inc.sys_id !== sysId);
          
          // Re-render the dashboard
          renderDashboard();
          updateSummaryCards();
        } else {
          // Just update the state in local data
          const incident = allIncidentData.find(inc => inc.sys_id === sysId);
          if (incident) {
            incident.state = newState;
          }
          const incidentInFiltered = incidentData.find(inc => inc.sys_id === sysId);
          if (incidentInFiltered) {
            incidentInFiltered.state = newState;
          }
        }
      } else {
        showNotification(`Failed to update ${incidentNumber}`, 'error');
        load();
      }
      } catch (err) {
        console.error('Error updating incident states:', err);
        showNotification('Error updating incident state', 'error');
        load();
      }
    }

    // --- Fetch incidents data from ServiceNow via API ---
    async function load() {
      try {
        const filterType = document.getElementById("filterSelect").value;
        const statusFilter = document.getElementById("statusFilter").value;

        // Build API URL with filter parameter
        let apiUrl = "/api/incidents?";

        if (filterType === "missed") {
          apiUrl += "filter=missed";
        }

        if (statusFilter === "all") {
          apiUrl += "&includeInactive=true";
        }

        const eRes = await fetch(apiUrl);
        const eData = await eRes.json();

        if (eData.success) {
          incidentData = eData.incident || [];
          allIncidentData = [...incidentData]; // keep a copy

          // Do not reset when loading new data - perserve current sort. 
          // Re-apply current sort if one exists.
          if (currentSort.column && currentSort.direction !== 'none') {
            sortTable(currentSort.column, true); // true = preserve direction
          } else {
            renderDashboard();
            updateSummaryCards();
          } 
        } else {
          console.error("Failed to fetch incidents");
        }
      } catch (err) {
        console.error("Error loading incidents:", err);
      }
    }

    // --- Update summary cards ---
    function updateSummaryCards() {
      // Total incidents
      document.getElementById("totalIncidents").textContent = allIncidentData.length;

      // Count missed alerts (those with "Missed check-in alert" in description)
      const missedCount = allIncidentData.filter(inc => 
        (inc.short_description || "").toLowerCase().includes("missed check-in alert")
      ).length;
      document.getElementById("missedAlerts").textContent = missedCount;

      // Count high priority (priority 1 or 2)
      const highPriorityCount = allIncidentData.filter(inc => 
        inc.priority === "1" || inc.priority === "2"
      ).length;
      document.getElementById("highPriority").textContent = highPriorityCount;
    }

    function createStateDropdown(incident) {
      const currentState = incident.state;
      const stateClass = stateClassMap[currentState] || '';

      let options = '';
      for (const [value, label] of Object.entries(stateMap)) {
        const selected = value === currentState ? 'selected' : '';
        options += `<option value="${value}" ${selected}>${label}</option>`;
      }

      return `
        <select
          class ="state-select ${stateClass}"
          data-sys-id="${incident.sys_id}"
          data-incident-number="${incident.number}"
          onchange="handleStateChange(this)"
        >
          ${options}
        </select>
        `;
    }

    // --- Handle state change ---
    window.handleStateChange = function(selectElement) {
      const newState = selectElement.value;
      const sysId = selectElement.dataset.sysId;
      const incidentNumber = selectElement.dataset.incidentNumber;

      // Check if moving to inactive state
      const inactiveStates = ["6", "7", "8"] // Resolved, Closed, Canceled
      const movingToInactive = inactiveStates.includes(newState);

      // Confirm if moving to inactive state
      if (movingToInactive) {
        const stateNames = {
          "6": "Resolved",
          "7": "Closed",
          "8": "Canceled"
        };

        const confirmed = confirm(
          `Are you sure you want to mark ${incidentNumber} as ${stateNames[newState]}?\n\n` +
          `This incident will be removed from the active dashboard.`
        );

        if (!confirmed) {
          // Revert the dropdown to the original value
          load();
          return;
        }
      }

      // Update te dropdown's color class
      selectElement.className = `state-select ${stateClassMap[newState] || ''}`;

      // Update in ServiceNow
      updateIncidentStateWithRemoval(incidentNumber, sysId, newState);
    };

    // --- Render dashbaord table ---
    function renderDashboard() {
      const body = document.getElementById("incidentBody");
      const searchTerm = document.getElementById("searchInput").value.toLowerCase();
      
      // Filter data based on search term
      let filteredData = incidentData;

      if (searchTerm) {
        filteredData = incidentData.filter(incident => {
          const parsed = parseShortDescription(incident.short_description);
          const desc = (incident.short_description || "").toLowerCase();
          const number = (incident.number || "").toLowerCase();
          const state = (stateMap[incident.state] || "").toLowerCase();
          const alertType = parsed.alertType.toLowerCase();
          const elderlyName = parsed.elderlyName.toLowerCase();

          return desc.includes(searchTerm) ||
                  number.includes(searchTerm) ||
                  state.includes(searchTerm) ||
                  alertType.includes(searchTerm) ||
                  elderlyName.includes(searchTerm);
        });
      }

      // Clear table
      body.innerHTML = "";

      // If no results
      if (filteredData.length === 0) {
        body.innerHTML = `
        <tr>
          <td colspan="5" class="no-results">
            No incidents found matching your criteria
          </td>
        </tr>
        `;
        return;
      }

      // Render rows 
      filteredData.forEach(incident => {
        const parsed = parseShortDescription(incident.short_description);
        const isMissedAlert = (incident.short_description || "").toLowerCase().includes("missed check-in alert");
        const rowClass = isMissedAlert ? 'missed-alert' : '';

        // Format the opened_at date
        const openedDate = incident.opened_at != "NA"
          ? new Date(incident.opened_at).toLocaleString('en-SG', { 
              year: 'numeric', 
              month: 'short', 
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            })
          : incident.opened_at;

          const priorityLabel = priorityMap[incident.priority] || incident.priority;
          const stateDropdown = createStateDropdown(incident)

        const row = `
          <tr class="${rowClass}">
            <td>${incident.number}</td>
            <td>${openedDate}</td>
            <td>${parsed.alertType}</td>
            <td>${parsed.elderlyName}</td>
            <td>${priorityLabel}</td>
            <td>${stateDropdown}</td>
          </tr>
        `;
        body.insertAdjacentHTML("beforeend", row);
      });
    }

    // --- Event listeners --- 
    document.getElementById("searchInput").addEventListener("input", renderDashboard);

    document.getElementById("filterSelect").addEventListener("change", () => {
      load(); // Reload data with new filter
    });

    document.getElementById("statusFilter").addEventListener("change", () => {
      load(); // Reload data with new filter
    });

    // --- Auto-refresh every 5secs ---
    load().then(() => {
      setInterval(() => {
        load();
      }, 5000);
    });
  </script>
</body>

</html> 
